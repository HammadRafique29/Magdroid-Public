# Simplified Docker Compose for local development.
# Each service loads its own .env file from its respective directory.

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        NEXT_PUBLIC_BACKEND_API_URL: ${NEXT_PUBLIC_BACKEND_API_URL}
        FRONTEND_PORT: ${FRONTEND_PORT}
    
    image: magdroid-frontend:v1.1
    container_name: magdroid_frontend
    restart: unless-stopped
    environment:
      FRONTEND_PORT: ${FRONTEND_PORT}
      NEXT_PUBLIC_API_BASE_URL: "/api"
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      NEXT_PUBLIC_BACKEND_API_URL: ${NEXT_PUBLIC_BACKEND_API_URL}
    
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"

    extra_hosts:
      - "host.docker.internal:host-gateway"
    



  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        BACKEND_PORT: ${BACKEND_PORT}
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}

    image: magdroid-backend:v1.1
    container_name: magdroid_backend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_JWKS_URL: ${CLERK_JWKS_URL}
      CLERK_ISSUER: ${CLERK_ISSUER}
      CLOUDFLARED_TUNNEL_TOKEN: ${CLOUDFLARED_TUNNEL_TOKEN}
      CORS_ORIGINS: ${CORS_ORIGINS}
      ADB_SERVER_PORT: ${ADB_SERVER_PORT}
      DEVICES_RANGE: ${DEVICES_RANGE}
    
    volumes:
      - /home/${USER}/Documents/Automation/MagDroid/data:/app/data
      - /dev/bus/usb:/dev/bus/usb
      
    network_mode: "host"
    privileged: true
    
